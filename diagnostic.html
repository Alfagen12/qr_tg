<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ QR Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .btn {
            background: #2481cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            font-size: 16px;
        }
        .btn:hover { background: #1c6ab8; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
        .info { background: #f0f8ff; padding: 10px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß QR Scanner - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    
    <div class="info">
        <strong>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É —Å –∫–∞–º–µ—Ä–æ–π</strong><br>
        –ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ª–æ–≥–µ
    </div>

    <button class="btn" onclick="checkBasicSupport()">1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑–æ–≤—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
    <button class="btn" onclick="checkCameraPermissions()">2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã</button>
    <button class="btn" onclick="listCameras()">3. –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä</button>
    <button class="btn" onclick="testCameraAccess()">4. –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</button>
    <button class="btn" onclick="testBarcodeDetector()">5. –¢–µ—Å—Ç BarcodeDetector</button>
    <button class="btn" onclick="clearCache()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>

    <div id="log" class="log">üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É...\n</div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function checkBasicSupport() {
            log('=== –ü–†–û–í–ï–†–ö–ê –ë–ê–ó–û–í–û–ô –ü–û–î–î–ï–†–ñ–ö–ò ===');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ navigator.mediaDevices
            if (!navigator.mediaDevices) {
                log('navigator.mediaDevices –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            log('‚úì navigator.mediaDevices –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ getUserMedia
            if (!navigator.mediaDevices.getUserMedia) {
                log('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            log('‚úì getUserMedia –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ BarcodeDetector
            if (!('BarcodeDetector' in window)) {
                log('BarcodeDetector –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                log('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ Chromium', 'warning');
                return;
            }
            log('‚úì BarcodeDetector –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ
            log(`User Agent: ${navigator.userAgent}`);
            log(`Platform: ${navigator.platform}`);
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            log(`–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${isMobile ? '–î–∞' : '–ù–µ—Ç'}`);
        }

        async function checkCameraPermissions() {
            log('=== –ü–†–û–í–ï–†–ö–ê –†–ê–ó–†–ï–®–ï–ù–ò–ô –ö–ê–ú–ï–†–´ ===');
            
            try {
                const permissions = await navigator.permissions.query({ name: 'camera' });
                log(`–°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã: ${permissions.state}`);
                
                if (permissions.state === 'denied') {
                    log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞/Telegram', 'error');
                } else if (permissions.state === 'granted') {
                    log('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Ä–∞–∑—Ä–µ—à–µ–Ω', 'success');
                } else {
                    log('–°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: prompt (–±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–æ)', 'warning');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${error.message}`, 'error');
            }
        }

        async function listCameras() {
            log('=== –°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –ö–ê–ú–ï–† ===');
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                log(`–ù–∞–π–¥–µ–Ω–æ –≤–∏–¥–µ–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${videoDevices.length}`);
                
                videoDevices.forEach((device, index) => {
                    log(`${index + 1}. ${device.label || '–ö–∞–º–µ—Ä–∞ ' + (index + 1)} (ID: ${device.deviceId})`);
                });
                
                if (videoDevices.length === 0) {
                    log('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞–º–µ—Ä—ã', 'error');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä: ${error.message}`, 'error');
            }
        }

        async function testCameraAccess() {
            log('=== –¢–ï–°–¢ –î–û–°–¢–£–ü–ê –ö –ö–ê–ú–ï–†–ï ===');
            
            const constraints = [
                { video: { facingMode: 'environment' } },
                { video: { facingMode: 'user' } },
                { video: true }
            ];
            
            for (let i = 0; i < constraints.length; i++) {
                try {
                    log(`–ü–æ–ø—ã—Ç–∫–∞ ${i + 1}: ${JSON.stringify(constraints[i])}`);
                    const stream = await navigator.mediaDevices.getUserMedia(constraints[i]);
                    log(`‚úì –£—Å–ø–µ—à–Ω–æ! –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${stream.getVideoTracks()[0].getSettings().width}x${stream.getVideoTracks()[0].getSettings().height}`, 'success');
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
                    stream.getTracks().forEach(track => track.stop());
                    return;
                } catch (error) {
                    log(`‚úó –û—à–∏–±–∫–∞: ${error.name} - ${error.message}`, 'error');
                }
            }
            
            log('–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –Ω–µ—É–¥–∞—á–Ω—ã', 'error');
        }

        async function testBarcodeDetector() {
            log('=== –¢–ï–°–¢ BARCODEDETECTOR ===');
            
            if (!('BarcodeDetector' in window)) {
                log('BarcodeDetector –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                return;
            }
            
            try {
                const detector = new BarcodeDetector();
                log('‚úì BarcodeDetector —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                const formats = await BarcodeDetector.getSupportedFormats();
                log(`–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: ${formats.join(', ')}`);
                
                if (formats.includes('qr_code')) {
                    log('‚úì QR-–∫–æ–¥—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è', 'success');
                } else {
                    log('QR-–∫–æ–¥—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è', 'error');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è BarcodeDetector: ${error.message}`, 'error');
            }
        }

        function clearCache() {
            log('=== –û–ß–ò–°–¢–ö–ê –ö–ï–®–ê ===');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                        log('Service Worker –æ—Ç–∫–ª—é—á–µ–Ω');
                    }
                });
            }
            
            // –û—á–∏—Å—Ç–∫–∞ localStorage
            localStorage.clear();
            log('localStorage –æ—á–∏—â–µ–Ω');
            
            // –û—á–∏—Å—Ç–∫–∞ sessionStorage
            sessionStorage.clear();
            log('sessionStorage –æ—á–∏—â–µ–Ω');
            
            log('–ö–µ—à –æ—á–∏—â–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...', 'warning');
            
            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        window.addEventListener('load', () => {
            setTimeout(checkBasicSupport, 500);
        });
    </script>
</body>
</html>
